// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© shubhamtaywade82

//@version=6
indicator("ML Adaptive SuperTrend [nemesis] - Trend Detection", overlay=true)

// INPUTS
atr_len = input.int(10, "ATR Length")
fact = input.float(1, "SuperTrend Factor")
training_data_period = input.int(100, "Training Data Length")
highvol = input.float(0.75, "High Volatility Percentile")
midvol = input.float(0.5, "Medium Volatility Percentile")
lowvol = input.float(0.25, "Low Volatility Percentile")

// COLOR SETTINGS
t1 = input.int(70, "Transparency 1")
t2 = input.int(95, "Transparency 2")
green = input.color(color.blue, "Bullish Color")
red = input.color(#ff1100, "Bearish Color")

pine_supertrend(factor, atr) =>
    src = hl2
    upperBand = src + factor * atr
    lowerBand = src - factor * atr
    prevLowerBand = nz(lowerBand[1])
    prevUpperBand = nz(upperBand[1])

    lowerBand := lowerBand > prevLowerBand or close[1] < prevLowerBand ? lowerBand : prevLowerBand
    upperBand := upperBand < prevUpperBand or close[1] > prevUpperBand ? upperBand : prevUpperBand

    int _direction = na
    float superTrend = na
    prevSuperTrend = superTrend[1]
    if na(atr[1])
        _direction := 1
    else if prevSuperTrend == prevUpperBand
        _direction := close > upperBand ? -1 : 1
    else
        _direction := close < lowerBand ? 1 : -1

    superTrend := _direction == -1 ? lowerBand : upperBand
    [superTrend, _direction]

volatility = ta.atr(atr_len)
upper = ta.highest(volatility, training_data_period)
lower = ta.lowest(volatility, training_data_period)

hvNew = lower + (upper - lower) * highvol
mvNew = lower + (upper - lower) * midvol
lvNew = lower + (upper - lower) * lowvol

vdist_a = math.abs(volatility - hvNew)
vdist_b = math.abs(volatility - mvNew)
vdist_c = math.abs(volatility - lvNew)

cluster = vdist_a < vdist_b and vdist_a < vdist_c ? 0 : vdist_b < vdist_c ? 1 : 2
assigned_centroid = cluster == 0 ? hvNew : cluster == 1 ? mvNew : lvNew

[ST, dir] = pine_supertrend(fact, assigned_centroid)

plot(dir < 0 ? ST : na, color=color.new(green, t1), style=plot.style_linebr)
plot(dir > 0 ? ST : na, color=color.new(red, t1), style=plot.style_linebr)

plotshape(ta.crossunder(dir, 0), title="Bullish Trend", style=shape.labelup, location=location.belowbar, color=green, text="Bullish", textcolor=color.white)
plotshape(ta.crossover(dir, 0), title="Bearish Trend", style=shape.labeldown, location=location.abovebar, color=red, text="Bearish", textcolor=color.white)

// ALERTS
bullishShift = ta.crossunder(dir, 0)
bearishShift = ta.crossover(dir, 0)
hiVol = cluster == 0 and cluster[1] != 0
midVol = cluster == 1 and cluster[1] != 1
lowVol = cluster == 2 and cluster[1] != 2

if bullishShift
    alert("ðŸ“ˆ Bullish trend shift detected", alert.freq_once_per_bar_close)
if bearishShift
    alert("ðŸ“‰ Bearish trend shift detected", alert.freq_once_per_bar_close)
if hiVol
    alert("âš¡ High-volatility regime", alert.freq_once_per_bar_close)
if midVol
    alert("ðŸ”† Medium-volatility regime", alert.freq_once_per_bar_close)
if lowVol
    alert("ðŸŒ™ Low-volatility regime", alert.freq_once_per_bar_close)