# Update notes – 2026-01-28

## RSpec fixes

- **Spec type inference** – Uncommented `config.infer_spec_type_from_file_location!` in `spec/rails_helper.rb` so that:
  - `spec/requests/*` get `get` / `post` / `response`
  - `spec/models/*` get the correct type for shoulda-matchers
- **Shoulda-matchers** – Added `require 'shoulda/matchers'` in `spec/support/shoulda_matcher.rb` so `validate_presence_of`, `belong_to`, etc. are available in model specs.

Result: previously failing model and request specs (e.g. AppSetting, Level, Order, Position, Quote, SwingPick, MCP, SwingPicks, Telegram) all pass.

---

## Warning cleanup

### EDIS "already initialized constant"

- **Cause** – In `spec/services/alert_processors/stock_spec.rb`, stubbing the whole `Dhanhq::API` module with `stub_const` redefined `Dhanhq::API::EDIS` on every example.
- **Fix** – Stopped using `stub_const` for `Dhanhq::API`. Now only stub the methods under test: `allow(Dhanhq::API::EDIS).to receive_messages(...)` and `allow(Dhanhq::API::Orders).to receive(:place).and_return(...)`.

### BinData "replacing registered class"

- **Cause** – The app had its own `Dhan::Ws::Packets::*` (Header, FullPacket, QuotePacket, MarketDepthLevel) that duplicated the DhanHQ gem’s `DhanHQ::WS::Packets::*`. Loading both triggered BinData’s “replacing registered class” warnings.
- **Fix** – Use the gem’s parser and packets only; remove the app’s duplicate packet code (see next section). No `$VERBOSE` or other workarounds.

---

## DhanHQ::WS – use gem instead of app copies

- **Goal** – Rely on the DhanHQ dhanhq-client gem for WebSocket packet parsing and remove duplicate, app-local packet definitions.
- **Changes**:
  1. **FeedListener** (`app/services/dhan/ws/feed_listener.rb`) – Uses `DhanHQ::WS::WebsocketPacketParser` instead of the old `WebsocketPacketParser`. Added `normalize_market_depth(packet)` to convert the gem’s BinData `market_depth` into an array of hashes for existing handlers.
  2. **Removed app packet code** – Deleted:
     - `app/services/dhan/ws/websocket_packet_parser.rb`
     - `app/services/dhan/ws/packets/header.rb`
     - `app/services/dhan/ws/packets/full_packet.rb`
     - `app/services/dhan/ws/packets/quote_packet.rb`
     - `app/services/dhan/ws/packets/market_depth_level.rb`
  3. **Spec** – `spec/services/dhan/dhan/ws/websocket_packet_parser_spec.rb` now targets `DhanHQ::WS::WebsocketPacketParser` and expects struct-style access (e.g. `depth[0].ask_price`).
  4. **Rails helper** – Removed the `$VERBOSE` / `$rspec_original_verbose` logic in `spec/rails_helper.rb` that was hiding BinData warnings.

Result: no more “replacing registered class” warnings; a single source of packet definitions (the gem); all 332 examples passing.

---

## Integration specs (stub only external boundaries)

- **Goal** – Add examples that stub **only** external boundaries (API, broker, Telegram, HTTP) and let internal services run; keep existing unit specs as they are.
- **Changes** – Added an **integration** context to three specs:
  1. **PortfolioInsights::DailyReporterJob** – Unit examples under `context 'unit tests (internal services stubbed)'`; new `context 'integration: stubs only external boundaries'` stubs Holdings, Funds, MarketFeed, Openai, Telegram and runs real `PortfolioInsights::Analyzer`. Asserts job completes and `Openai::ChatRouter.ask!` is called with expected prompt.
  2. **Positions::Manager** – New integration context stubs Position.all, Order.all/find, Telegram; runs real `Orders::Analyzer` and `Orders::Manager`. Asserts Analyzer and Manager are called with correct position and analysis.
  3. **Orders::Manager** – New integration context runs real `Orders::RiskManager`; position/analysis trigger take-profit. Asserts `Orders::Executor` is invoked with reason `'TakeProfit'`.
- **Docs** – Updated `docs/updates/SPEC_STUBBING_AUDIT.md` with "Integration examples added" and marked plan items done.
